from gensim.models import Word2Vec
from androguard.misc import AnalyzeAPK
import json
import os
import shutil

def apk_to_code(apk_path, token):
    a, d, dx = AnalyzeAPK(apk_path)

    # Duyệt qua tất cả các phương thức
    for method in dx.get_methods():
        method_name = method.get_method().get_name()
        if method_name is not None :
            method_name = method_name.replace(':', '')
            token.add(method_name)

def embed_vecs(directory, vector_path):
    model = Word2Vec.load("C:\Users\admin\Desktop\tai-lieu\Năm 3-2\ATBM\BTL\word2vec\word2vec_full.model")
    unreadable_files = []
    files = 2991
    for file in os.listdir(directory):
        tokens = set()
        res = []
        filename = os.fsdecode(file)
        if filename.endswith(".apk") and files > 0 : 
            try:
                apk_to_code(os.path.join(directory, filename), tokens)
                for word in tokens:
                    try:
                        word_embedding = model.wv.get_vector(word.lower())
                        res.append(word_embedding.tolist())
                    except :
                        print (word.lower() + "not in dict")
                with open(vector_path + str(filename)[:-4] + '.json', 'w') as json_file:
                    json.dump(res, json_file)
            except:
                unreadable_files.append(str(filename))
        files-=1

embed_vecs('/home/manh1082003/DetectMalwareOnAndroid/malware - Copy')



# # print(res)
# with open ('error_file_embed', 'w') as w_file:
#     data = ""
#     for file in unreadable_files:
#         data += file + "\n"
#     w_file.write(data)
# tokens = []


# model = Word2Vec(sentences=tokens, vector_size=600, window=5, min_count=1, workers=4)







